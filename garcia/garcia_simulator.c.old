#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>

#include "gmp.h"
#include "paillier.h"

/*int N = 10;
int measurements[10] = {
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000
};

int N = 100;
int measurements[100] = {
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000
};
*/
int N = 1000;
int measurements[1000] = {
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000,
  10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000
};

int *self_secrets;
int *partial_Ms;

paillier_ciphertext_t ***enc_secrets;
paillier_ciphertext_t **partial_ms;
paillier_pubkey_t **pubkeys;
paillier_prvkey_t **prvkeys;

struct meter_info {
  int id;
};

void init_variables() {
  self_secrets = calloc(N, sizeof(int));
  enc_secrets = calloc(N, sizeof(paillier_ciphertext_t **));
  int i;
  for (i = 0; i < N; i++) {
    enc_secrets[i] = calloc(N, sizeof(paillier_ciphertext_t *));
  }
  partial_ms = calloc(N, sizeof(paillier_ciphertext_t *));
  partial_Ms = calloc(N, sizeof(int *));

  pubkeys = calloc(N, sizeof(paillier_pubkey_t));
  prvkeys = calloc(N, sizeof(paillier_pubkey_t));
  

}

void *meter_start(void *data) {
  struct meter_info *info = data;
  paillier_pubkey_t *pubkey;
  paillier_prvkey_t *prvkey;
  paillier_keygen(2048, &pubkey, &prvkey, paillier_get_rand_devurandom);
  pubkeys[info->id] = pubkey;
  prvkeys[info->id] = prvkey;
  free(info);
}

void *meter_secret_sharings(void *data) {
  struct meter_info *info = data;
  int m = measurements[info->id];
  
  int j;
  for (j = 0; j < N; j++) {
    int sij = m / N;
    if (j == info->id) {
      self_secrets[info->id] = sij;
    } else {
      paillier_plaintext_t* pt = paillier_plaintext_from_ui(sij);
      enc_secrets[j][info->id] = paillier_enc(NULL, pubkeys[j], pt, 
          paillier_get_rand_devurandom);
    }
  }

  free(info);
}

void *meter_add_self_secret(void *data) {
  struct meter_info *info = data;
  paillier_plaintext_t* pt = paillier_dec(NULL, pubkeys[info->id], 
      prvkeys[info->id], partial_ms[info->id]);

  partial_Ms[info->id] = (int) mpz_get_ui(pt->m) + self_secrets[info->id];
  free(info);
}



void steps_1_and_2() {
  printf("Initializing %d meters and generating keys...\n\n", N);
  pthread_t meter_tid[N];

  int i;
  for (i = 0; i < N; i++) {
    struct meter_info *info = malloc(sizeof(struct meter_info));
    info->id = i;
    pthread_create(&(meter_tid[i]), NULL, &meter_start, (void *) info);
  }

  for (i = 0; i < N; i++) {
    pthread_join(meter_tid[i], NULL);
  }
}

void steps_3_and_4() {
  printf("Meters are generating secret sharings and encrypting them...\n\n");
  pthread_t meter_tid[N];

  int i;
  for (i = 0; i < N; i++) {
    struct meter_info *info = malloc(sizeof(struct meter_info));
    info->id = i;
    pthread_create(&(meter_tid[i]), NULL, &meter_secret_sharings, (void *) info);
  }

  for (i = 0; i < N; i++) {
    pthread_join(meter_tid[i], NULL);
  }
}

void step_5() {
  printf("Power provider is multiplying the shares that has been "
      "encrypted with the same public key\n\n");
  int i, j;
  for (i = 0; i < N; i++) {
    paillier_ciphertext_t* res = paillier_create_enc_zero();
    for (j = 0; j < N; j++) {
      if (i != j) {
        paillier_mul(pubkeys[i], res, res, enc_secrets[i][j]);
      }
    }
    partial_ms[i] = res;
  }
}

void step_6() {
  printf("Meters are decrypting the partial measurements and "
      "adding their self secrets...\n\n");
  pthread_t meter_tid[N];

  int i;
  for (i = 0; i < N; i++) {
    struct meter_info *info = malloc(sizeof(struct meter_info));
    info->id = i;
    pthread_create(&(meter_tid[i]), NULL, &meter_add_self_secret, (void *) info);
  }

  for (i = 0; i < N; i++) {
    pthread_join(meter_tid[i], NULL);
  }
}

void step_7() {
  printf("Power provider is summing all partial Ms to obtain the total (M)\n\n");
  int i;
  int M = 0;
  for (i = 0; i < N; i++) {
    M += partial_Ms[i];
  }
  printf("Total consumption regional consumption is M = %d\n", M);
}

int main() {
  init_variables();

  steps_1_and_2();
  steps_3_and_4();
  step_5();
  step_6();
  step_7();
}
